---
groups:
  - name: "matrix_cloud_blockchain_syncer"
    rules:
      - alert: "serverDown"
        expr: "up{app='matrix-cloud-blockchain-syncer', cluster='matrix-prod'} < 1"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} is down"
          description: "{{ $labels.kubernetes_namespace }} {{$labels.app}} is not 100% available"
        labels:
          severity: "critical"
          project: marketplace
        for: "3m"
      - alert: "cpuTooHeight"
        expr: "sum(irate(container_cpu_usage_seconds_total{container='matrix-cloud-blockchain-syncer', cluster='matrix-prod'}[3m])*100) by (pod) > 70"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} cpu usage is exceed threshold"
          description: "{{ $labels.kubernetes_namespace }} {{$labels.app}} cpu usage is exceed threshold: 70%"
        labels:
          severity: "critical"
          project: marketplace
        for: "2m"
      - alert: "memTooHeight"
        expr: "sum(container_memory_working_set_bytes{container='matrix-cloud-blockchain-syncer', cluster='matrix-prod'}/1024/1024/1024) by (pod) > 2"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} mem usage is exceed threshold"
          description: "{{ $labels.kubernetes_namespace }} {{$labels.app}} mem usage is exceed threshold: 2G"
        labels:
          severity: "critical"
          project: marketplace
        for: "2m"
      - alert: "jvmHeapTooHeight"
        expr: "sum(jvm_memory_used_bytes{cluster='matrix-prod', app='matrix-cloud-blockchain-syncer', area='heap'}) by (kubernetes_pod_name) / 1024 / 1024 > 2048"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} jvm heap usage is exceed threshold"
          description: "{{ $labels.kubernetes_namespace }} {{$labels.app}} jvm heap usage is exceed threshold: 2048M"
        labels:
          severity: "critical"
          project: marketplace
        for: "2m"
      - alert: "Service_Response_5xx"
        expr: "increase(istio_requests_total{app='matrix-cloud-blockchain-syncer', cluster='matrix-prod', response_code=~'5.*'}[1m]) > 0"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} response 5xx"
          description: "{{ $labels.cluster }} {{$labels.kubernetes_namespace}} {{$labels.app}} response {{$labels.response_code}}"
        labels:
          severity: "critical"
          project: marketplace
        for: "1m"
      - alert: "syncFailed"
        expr: "increase(blockchain_sync_error{cluster='matrix-prod'}[1m]) > 1"
        annotations:
          summary: "{{ $labels.kubernetes_namespace }} {{$labels.app}} failed to sync blockchain"
          description: "{{ $labels.kubernetes_namespace }} {{$labels.app}} failed to sync blockchain over 1 in 1 min"
        labels:
          severity: "critical"
          project: marketplace
        for: "2m"
